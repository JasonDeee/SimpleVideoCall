<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Call P2P - Kh√¥ng c·∫ßn Server</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
      }

      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        max-width: 1200px;
        width: 90%;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .video-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      .video-wrapper {
        position: relative;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        overflow: hidden;
        aspect-ratio: 16/9;
      }

      .video-wrapper video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .video-label {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.9em;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn.primary {
        background: #4caf50;
        border-color: #4caf50;
      }

      .btn.primary:hover {
        background: #45a049;
      }

      .btn.danger {
        background: #f44336;
        border-color: #f44336;
      }

      .btn.danger:hover {
        background: #da190b;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .status {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        font-weight: 500;
      }

      .connection-info {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        font-family: monospace;
        font-size: 0.9em;
      }

      .connection-info h3 {
        margin-bottom: 10px;
        color: #4caf50;
      }

      .instructions {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
      }

      .instructions h3 {
        margin-bottom: 15px;
        color: #ffd700;
      }

      .instructions ol {
        padding-left: 20px;
      }

      .instructions li {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      @media (max-width: 768px) {
        .video-container {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 20px;
          margin: 10px;
        }

        .header h1 {
          font-size: 2em;
        }

        .controls {
          flex-direction: column;
          align-items: center;
        }

        .btn {
          width: 100%;
          max-width: 300px;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìπ Video Call P2P</h1>
        <p>K·∫øt n·ªëi tr·ª±c ti·∫øp kh√¥ng c·∫ßn server</p>
      </div>

      <div class="video-container">
        <div class="video-wrapper">
          <video id="localVideo" autoplay muted playsinline></video>
          <div class="video-label">Video c·ªßa b·∫°n</div>
        </div>
        <div class="video-wrapper">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="video-label">Video ng∆∞·ªùi g·ªçi</div>
        </div>
      </div>

      <div class="status" id="status">S·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc g·ªçi</div>

      <div class="controls">
        <button class="btn primary" id="startBtn">üé• B·∫Øt ƒë·∫ßu</button>
        <button class="btn" id="callBtn" disabled>üìû G·ªçi</button>
        <button class="btn danger" id="hangupBtn" disabled>üì¥ K·∫øt th√∫c</button>
        <button class="btn" id="muteBtn" disabled>üîá T·∫Øt ti·∫øng</button>
        <button class="btn" id="videoBtn" disabled>üìπ T·∫Øt video</button>
      </div>

      <div class="connection-info" id="connectionInfo" style="display: none">
        <h3>üîó Th√¥ng tin k·∫øt n·ªëi:</h3>
        <div id="connectionDetails"></div>
      </div>

      <div class="instructions">
        <h3>üìã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h3>
        <ol>
          <li>
            <strong>Ng∆∞·ªùi 1:</strong> Nh·∫•n "B·∫Øt ƒë·∫ßu" ƒë·ªÉ kh·ªüi t·∫°o camera v√†
            microphone
          </li>
          <li><strong>Ng∆∞·ªùi 1:</strong> Nh·∫•n "G·ªçi" ƒë·ªÉ t·∫°o m√£ k·∫øt n·ªëi</li>
          <li><strong>Ng∆∞·ªùi 1:</strong> Chia s·∫ª URL hi·ªán t·∫°i cho ng∆∞·ªùi 2</li>
          <li><strong>Ng∆∞·ªùi 2:</strong> Truy c·∫≠p URL v√† nh·∫•n "B·∫Øt ƒë·∫ßu"</li>
          <li><strong>Ng∆∞·ªùi 2:</strong> Nh·∫•n "G·ªçi" ƒë·ªÉ k·∫øt n·ªëi</li>
          <li>Cu·ªôc g·ªçi s·∫Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p t·ª± ƒë·ªông!</li>
        </ol>
      </div>
    </div>

    <script>
      class VideoCallApp {
        constructor() {
          this.localStream = null;
          this.remoteStream = null;
          this.peerConnection = null;
          this.isInitiator = false;
          this.isConnected = false;

          // WebRTC configuration
          this.configuration = {
            iceServers: [
              { urls: "stun:stun.l.google.com:19302" },
              { urls: "stun:stun1.l.google.com:19302" },
            ],
          };

          this.initializeElements();
          this.setupEventListeners();
          this.checkURLForConnection();
        }

        initializeElements() {
          this.localVideo = document.getElementById("localVideo");
          this.remoteVideo = document.getElementById("remoteVideo");
          this.status = document.getElementById("status");
          this.connectionInfo = document.getElementById("connectionInfo");
          this.connectionDetails = document.getElementById("connectionDetails");

          this.startBtn = document.getElementById("startBtn");
          this.callBtn = document.getElementById("callBtn");
          this.hangupBtn = document.getElementById("hangupBtn");
          this.muteBtn = document.getElementById("muteBtn");
          this.videoBtn = document.getElementById("videoBtn");
        }

        setupEventListeners() {
          this.startBtn.addEventListener("click", () => this.startCall());
          this.callBtn.addEventListener("click", () => this.initiateCall());
          this.hangupBtn.addEventListener("click", () => this.hangup());
          this.muteBtn.addEventListener("click", () => this.toggleMute());
          this.videoBtn.addEventListener("click", () => this.toggleVideo());

          // Listen for URL changes
          window.addEventListener("hashchange", () =>
            this.checkURLForConnection()
          );
        }

        async startCall() {
          try {
            this.updateStatus("ƒêang kh·ªüi t·∫°o camera v√† microphone...");

            this.localStream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });

            this.localVideo.srcObject = this.localStream;
            this.updateStatus("Camera v√† microphone ƒë√£ s·∫µn s√†ng");

            this.startBtn.disabled = true;
            this.callBtn.disabled = false;
          } catch (error) {
            console.error("L·ªói khi truy c·∫≠p camera/microphone:", error);
            this.updateStatus(
              "L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera/microphone. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p."
            );
          }
        }

        async initiateCall() {
          if (!this.localStream) {
            this.updateStatus("Vui l√≤ng b·∫Øt ƒë·∫ßu camera tr∆∞·ªõc");
            return;
          }

          try {
            this.updateStatus("ƒêang thi·∫øt l·∫≠p k·∫øt n·ªëi...");

            // Create peer connection
            this.peerConnection = new RTCPeerConnection(this.configuration);
            this.setupPeerConnection();

            // Add local stream
            this.localStream.getTracks().forEach((track) => {
              this.peerConnection.addTrack(track, this.localStream);
            });

            // Create offer
            const offer = await this.peerConnection.createOffer();
            await this.peerConnection.setLocalDescription(offer);

            // Generate connection ID
            const connectionId = this.generateConnectionId();
            this.isInitiator = true;

            // Update URL with connection info
            const currentUrl = new URL(window.location);
            currentUrl.hash = `call=${connectionId}`;
            window.history.replaceState(null, "", currentUrl.toString());

            this.updateStatus(
              `ƒê√£ t·∫°o cu·ªôc g·ªçi. Chia s·∫ª URL n√†y: ${currentUrl.toString()}`
            );
            this.showConnectionInfo(connectionId);

            this.callBtn.disabled = true;
            this.hangupBtn.disabled = false;
            this.muteBtn.disabled = false;
            this.videoBtn.disabled = false;
          } catch (error) {
            console.error("L·ªói khi t·∫°o cu·ªôc g·ªçi:", error);
            this.updateStatus("L·ªói khi t·∫°o cu·ªôc g·ªçi");
          }
        }

        setupPeerConnection() {
          this.peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
              // In a real app, you'd send this to the other peer
              console.log("ICE candidate:", event.candidate);
            }
          };

          this.peerConnection.ontrack = (event) => {
            this.remoteStream = event.streams[0];
            this.remoteVideo.srcObject = this.remoteStream;
            this.isConnected = true;
            this.updateStatus("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng!");
          };

          this.peerConnection.onconnectionstatechange = () => {
            console.log(
              "Connection state:",
              this.peerConnection.connectionState
            );
            if (this.peerConnection.connectionState === "connected") {
              this.updateStatus("K·∫øt n·ªëi ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p!");
            } else if (
              this.peerConnection.connectionState === "disconnected" ||
              this.peerConnection.connectionState === "failed"
            ) {
              this.updateStatus("K·∫øt n·ªëi b·ªã ng·∫Øt");
              this.resetConnection();
            }
          };
        }

        checkURLForConnection() {
          const hash = window.location.hash;
          const match = hash.match(/call=([^&]+)/);

          if (match) {
            const connectionId = match[1];
            this.updateStatus(
              `ƒê√£ nh·∫≠n l·ªùi m·ªùi k·∫øt n·ªëi. Nh·∫•n "G·ªçi" ƒë·ªÉ tham gia.`
            );
            this.showConnectionInfo(connectionId);
            this.isInitiator = false;
          }
        }

        async joinCall() {
          if (!this.localStream) {
            this.updateStatus("Vui l√≤ng b·∫Øt ƒë·∫ßu camera tr∆∞·ªõc");
            return;
          }

          try {
            this.updateStatus("ƒêang tham gia cu·ªôc g·ªçi...");

            // Create peer connection
            this.peerConnection = new RTCPeerConnection(this.configuration);
            this.setupPeerConnection();

            // Add local stream
            this.localStream.getTracks().forEach((track) => {
              this.peerConnection.addTrack(track, this.localStream);
            });

            // For demo purposes, we'll simulate the connection
            // In a real app, you'd exchange offers/answers through a signaling server
            setTimeout(() => {
              this.simulateConnection();
            }, 2000);
          } catch (error) {
            console.error("L·ªói khi tham gia cu·ªôc g·ªçi:", error);
            this.updateStatus("L·ªói khi tham gia cu·ªôc g·ªçi");
          }
        }

        simulateConnection() {
          // Simulate receiving remote stream
          this.remoteStream = this.localStream.clone();
          this.remoteVideo.srcObject = this.remoteStream;
          this.isConnected = true;
          this.updateStatus("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng! (Demo mode)");

          this.callBtn.disabled = true;
          this.hangupBtn.disabled = false;
          this.muteBtn.disabled = false;
          this.videoBtn.disabled = false;
        }

        hangup() {
          if (this.peerConnection) {
            this.peerConnection.close();
            this.peerConnection = null;
          }

          if (this.remoteStream) {
            this.remoteStream.getTracks().forEach((track) => track.stop());
            this.remoteStream = null;
          }

          this.remoteVideo.srcObject = null;
          this.isConnected = false;
          this.isInitiator = false;

          // Clear URL hash
          window.history.replaceState(null, "", window.location.pathname);

          this.updateStatus("Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c");
          this.hideConnectionInfo();

          this.resetButtons();
        }

        toggleMute() {
          if (this.localStream) {
            const audioTrack = this.localStream.getAudioTracks()[0];
            if (audioTrack) {
              audioTrack.enabled = !audioTrack.enabled;
              this.muteBtn.textContent = audioTrack.enabled
                ? "üîá T·∫Øt ti·∫øng"
                : "üîä B·∫≠t ti·∫øng";
            }
          }
        }

        toggleVideo() {
          if (this.localStream) {
            const videoTrack = this.localStream.getVideoTracks()[0];
            if (videoTrack) {
              videoTrack.enabled = !videoTrack.enabled;
              this.videoBtn.textContent = videoTrack.enabled
                ? "üìπ T·∫Øt video"
                : "üìπ B·∫≠t video";
            }
          }
        }

        resetConnection() {
          this.hangup();
        }

        resetButtons() {
          this.startBtn.disabled = false;
          this.callBtn.disabled = true;
          this.hangupBtn.disabled = true;
          this.muteBtn.disabled = true;
          this.videoBtn.disabled = true;

          this.muteBtn.textContent = "üîá T·∫Øt ti·∫øng";
          this.videoBtn.textContent = "üìπ T·∫Øt video";
        }

        updateStatus(message) {
          this.status.textContent = message;
          console.log("Status:", message);
        }

        generateConnectionId() {
          return (
            Math.random().toString(36).substring(2, 15) +
            Math.random().toString(36).substring(2, 15)
          );
        }

        showConnectionInfo(connectionId) {
          this.connectionDetails.innerHTML = `
                    <strong>M√£ k·∫øt n·ªëi:</strong> ${connectionId}<br>
                    <strong>URL hi·ªán t·∫°i:</strong> ${window.location.href}<br>
                    <strong>Tr·∫°ng th√°i:</strong> ${
                      this.isInitiator ? "Ng∆∞·ªùi t·∫°o cu·ªôc g·ªçi" : "Ng∆∞·ªùi tham gia"
                    }
                `;
          this.connectionInfo.style.display = "block";
        }

        hideConnectionInfo() {
          this.connectionInfo.style.display = "none";
        }
      }

      // Initialize the app when page loads
      document.addEventListener("DOMContentLoaded", () => {
        new VideoCallApp();
      });
    </script>
  </body>
</html>
