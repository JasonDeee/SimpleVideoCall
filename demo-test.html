<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demo Test - Video Call P2P</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background: #f0f0f0;
      }
      .demo-container {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
      }
      .video-demo {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }
      .video-box {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f9f9f9;
      }
      .video-box.local {
        border-color: #4caf50;
        background: #e8f5e8;
      }
      .video-box.remote {
        border-color: #2196f3;
        background: #e3f2fd;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        font-weight: bold;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      .instructions {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
        margin: 15px 0;
      }
      .url-display {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        word-break: break-all;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Demo Test - Video Call P2P</h1>

    <div class="demo-container">
      <h2>üìã H∆∞·ªõng d·∫´n test:</h2>
      <div class="instructions">
        <p>
          <strong>B∆∞·ªõc 1:</strong> M·ªü 2 tab tr√¨nh duy·ªát kh√°c nhau (ho·∫∑c 2 c·ª≠a
          s·ªï)
        </p>
        <p>
          <strong>B∆∞·ªõc 2:</strong> Trong tab 1: Nh·∫•n "B·∫Øt ƒë·∫ßu" ‚Üí "G·ªçi" (Ng∆∞·ªùi 1)
        </p>
        <p><strong>B∆∞·ªõc 3:</strong> Copy URL t·ª´ tab 1 v√† paste v√†o tab 2</p>
        <p>
          <strong>B∆∞·ªõc 4:</strong> Trong tab 2: Nh·∫•n "B·∫Øt ƒë·∫ßu" ‚Üí "G·ªçi" (Ng∆∞·ªùi 2)
        </p>
        <p><strong>K·∫øt qu·∫£:</strong> C·∫£ 2 tab s·∫Ω hi·ªÉn th·ªã video kh√°c nhau!</p>
      </div>
    </div>

    <div class="demo-container">
      <h2>üé• Video Demo</h2>
      <div class="video-demo">
        <div class="video-box local">
          <div>
            <h3>üìπ Video c·ªßa b·∫°n</h3>
            <video
              id="localVideo"
              autoplay
              muted
              playsinline
              style="width: 100%; max-width: 300px; border-radius: 5px"
            ></video>
          </div>
        </div>
        <div class="video-box remote">
          <div>
            <h3>üë§ Video ng∆∞·ªùi g·ªçi</h3>
            <video
              id="remoteVideo"
              autoplay
              playsinline
              style="width: 100%; max-width: 300px; border-radius: 5px"
            ></video>
          </div>
        </div>
      </div>

      <div class="status info" id="status">S·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc g·ªçi</div>

      <div style="text-align: center; margin: 20px 0">
        <button id="startBtn">üé• B·∫Øt ƒë·∫ßu</button>
        <button id="callBtn" disabled>üìû G·ªçi</button>
        <button id="hangupBtn" disabled>üì¥ K·∫øt th√∫c</button>
        <button id="muteBtn" disabled>üîá T·∫Øt ti·∫øng</button>
        <button id="videoBtn" disabled>üìπ T·∫Øt video</button>
      </div>

      <div id="connectionInfo" style="display: none">
        <h3>üîó Th√¥ng tin k·∫øt n·ªëi:</h3>
        <div class="url-display" id="connectionDetails"></div>
      </div>
    </div>

    <script>
      // Simplified version of the main app for testing
      class DemoVideoCallApp {
        constructor() {
          this.localStream = null;
          this.remoteStream = null;
          this.peerConnection = null;
          this.isInitiator = false;
          this.isConnected = false;
          this.connectionId = null;

          this.initializeElements();
          this.setupEventListeners();
          this.checkURLForConnection();
        }

        initializeElements() {
          this.localVideo = document.getElementById("localVideo");
          this.remoteVideo = document.getElementById("remoteVideo");
          this.status = document.getElementById("status");
          this.connectionInfo = document.getElementById("connectionInfo");
          this.connectionDetails = document.getElementById("connectionDetails");

          this.startBtn = document.getElementById("startBtn");
          this.callBtn = document.getElementById("callBtn");
          this.hangupBtn = document.getElementById("hangupBtn");
          this.muteBtn = document.getElementById("muteBtn");
          this.videoBtn = document.getElementById("videoBtn");
        }

        setupEventListeners() {
          this.startBtn.addEventListener("click", () => this.startCall());
          this.callBtn.addEventListener("click", () => this.handleCallButton());
          this.hangupBtn.addEventListener("click", () => this.hangup());
          this.muteBtn.addEventListener("click", () => this.toggleMute());
          this.videoBtn.addEventListener("click", () => this.toggleVideo());
        }

        async startCall() {
          try {
            this.updateStatus("ƒêang kh·ªüi t·∫°o camera v√† microphone...");

            this.localStream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true,
            });

            this.localVideo.srcObject = this.localStream;
            this.updateStatus("Camera v√† microphone ƒë√£ s·∫µn s√†ng");

            this.startBtn.disabled = true;
            this.callBtn.disabled = false;
          } catch (error) {
            console.error("L·ªói khi truy c·∫≠p camera/microphone:", error);
            this.updateStatus(
              "L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera/microphone. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p."
            );
          }
        }

        handleCallButton() {
          if (this.connectionId && !this.isInitiator) {
            this.joinCall();
          } else {
            this.initiateCall();
          }
        }

        async initiateCall() {
          if (!this.localStream) {
            this.updateStatus("Vui l√≤ng b·∫Øt ƒë·∫ßu camera tr∆∞·ªõc");
            return;
          }

          try {
            this.updateStatus("ƒêang thi·∫øt l·∫≠p k·∫øt n·ªëi...");

            const connectionId = this.generateConnectionId();
            this.isInitiator = true;
            this.connectionId = connectionId;

            const currentUrl = new URL(window.location);
            currentUrl.hash = `call=${connectionId}`;
            window.history.replaceState(null, "", currentUrl.toString());

            this.updateStatus(
              `ƒê√£ t·∫°o cu·ªôc g·ªçi. Chia s·∫ª URL n√†y: ${currentUrl.toString()}`
            );
            this.showConnectionInfo(connectionId);

            this.callBtn.disabled = true;
            this.hangupBtn.disabled = false;
            this.muteBtn.disabled = false;
            this.videoBtn.disabled = false;

            // Simulate connection after 2 seconds
            setTimeout(() => {
              this.simulateConnection();
            }, 2000);
          } catch (error) {
            console.error("L·ªói khi t·∫°o cu·ªôc g·ªçi:", error);
            this.updateStatus("L·ªói khi t·∫°o cu·ªôc g·ªçi");
          }
        }

        async joinCall() {
          if (!this.localStream) {
            this.updateStatus("Vui l√≤ng b·∫Øt ƒë·∫ßu camera tr∆∞·ªõc");
            return;
          }

          try {
            this.updateStatus("ƒêang tham gia cu·ªôc g·ªçi...");

            this.callBtn.disabled = true;
            this.hangupBtn.disabled = false;
            this.muteBtn.disabled = false;
            this.videoBtn.disabled = false;

            // Simulate connection after 2 seconds
            setTimeout(() => {
              this.simulateConnection();
            }, 2000);
          } catch (error) {
            console.error("L·ªói khi tham gia cu·ªôc g·ªçi:", error);
            this.updateStatus("L·ªói khi tham gia cu·ªôc g·ªçi");
          }
        }

        simulateConnection() {
          this.createMockRemoteStream();
          this.isConnected = true;
          this.updateStatus("ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng! (Demo mode)");
        }

        async createMockRemoteStream() {
          try {
            const canvas = document.createElement("canvas");
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext("2d");

            // Create a different pattern for remote video
            const gradient = ctx.createLinearGradient(
              0,
              0,
              canvas.width,
              canvas.height
            );
            gradient.addColorStop(0, "#ff6b6b");
            gradient.addColorStop(1, "#4ecdc4");
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.textAlign = "center";
            ctx.fillText(
              "Remote Video Stream",
              canvas.width / 2,
              canvas.height / 2
            );
            ctx.fillText(
              "(Demo Mode)",
              canvas.width / 2,
              canvas.height / 2 + 30
            );

            const stream = canvas.captureStream(30);
            this.remoteStream = stream;
            this.remoteVideo.srcObject = this.remoteStream;
          } catch (error) {
            console.error("L·ªói khi t·∫°o mock remote stream:", error);
            this.remoteVideo.style.background =
              "linear-gradient(45deg, #ff6b6b, #4ecdc4)";
            this.remoteVideo.style.display = "flex";
            this.remoteVideo.style.alignItems = "center";
            this.remoteVideo.style.justifyContent = "center";
            this.remoteVideo.style.color = "white";
            this.remoteVideo.style.fontSize = "24px";
            this.remoteVideo.style.fontWeight = "bold";
            this.remoteVideo.innerHTML = "Remote Video<br/>(Demo Mode)";
          }
        }

        hangup() {
          if (this.remoteStream) {
            this.remoteStream.getTracks().forEach((track) => track.stop());
            this.remoteStream = null;
          }

          this.remoteVideo.srcObject = null;
          this.remoteVideo.style.background = "";
          this.remoteVideo.style.display = "";
          this.remoteVideo.style.alignItems = "";
          this.remoteVideo.style.justifyContent = "";
          this.remoteVideo.style.color = "";
          this.remoteVideo.style.fontSize = "";
          this.remoteVideo.style.fontWeight = "";
          this.remoteVideo.innerHTML = "";

          this.isConnected = false;
          this.isInitiator = false;
          this.connectionId = null;

          window.history.replaceState(null, "", window.location.pathname);

          this.updateStatus("Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c");
          this.hideConnectionInfo();
          this.resetButtons();
        }

        toggleMute() {
          if (this.localStream) {
            const audioTrack = this.localStream.getAudioTracks()[0];
            if (audioTrack) {
              audioTrack.enabled = !audioTrack.enabled;
              this.muteBtn.textContent = audioTrack.enabled
                ? "üîá T·∫Øt ti·∫øng"
                : "üîä B·∫≠t ti·∫øng";
            }
          }
        }

        toggleVideo() {
          if (this.localStream) {
            const videoTrack = this.localStream.getVideoTracks()[0];
            if (videoTrack) {
              videoTrack.enabled = !videoTrack.enabled;
              this.videoBtn.textContent = videoTrack.enabled
                ? "üìπ T·∫Øt video"
                : "üìπ B·∫≠t video";
            }
          }
        }

        resetButtons() {
          this.startBtn.disabled = false;
          this.callBtn.disabled = true;
          this.hangupBtn.disabled = true;
          this.muteBtn.disabled = true;
          this.videoBtn.disabled = true;

          this.muteBtn.textContent = "üîá T·∫Øt ti·∫øng";
          this.videoBtn.textContent = "üìπ T·∫Øt video";
        }

        updateStatus(message) {
          this.status.textContent = message;
          console.log("Status:", message);
        }

        generateConnectionId() {
          return (
            Math.random().toString(36).substring(2, 15) +
            Math.random().toString(36).substring(2, 15)
          );
        }

        showConnectionInfo(connectionId) {
          this.connectionDetails.innerHTML = `
                    <strong>M√£ k·∫øt n·ªëi:</strong> ${connectionId}<br>
                    <strong>URL hi·ªán t·∫°i:</strong> ${window.location.href}<br>
                    <strong>Tr·∫°ng th√°i:</strong> ${
                      this.isInitiator ? "Ng∆∞·ªùi t·∫°o cu·ªôc g·ªçi" : "Ng∆∞·ªùi tham gia"
                    }
                `;
          this.connectionInfo.style.display = "block";
        }

        hideConnectionInfo() {
          this.connectionInfo.style.display = "none";
        }

        checkURLForConnection() {
          const hash = window.location.hash;
          const match = hash.match(/call=([^&]+)/);

          if (match) {
            const connectionId = match[1];
            this.updateStatus(
              'ƒê√£ nh·∫≠n l·ªùi m·ªùi k·∫øt n·ªëi. Nh·∫•n "G·ªçi" ƒë·ªÉ tham gia.'
            );
            this.showConnectionInfo(connectionId);
            this.isInitiator = false;
            this.connectionId = connectionId;
          } else {
            this.isInitiator = true;
            this.connectionId = null;
          }
        }
      }

      // Initialize the demo app
      document.addEventListener("DOMContentLoaded", () => {
        new DemoVideoCallApp();
      });
    </script>
  </body>
</html>
